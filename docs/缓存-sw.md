

# serviceWorker

æ˜¯æµè§ˆå™¨åœ¨åå°**ç‹¬ç«‹äºç½‘é¡µ**è¿è¡Œçš„è„šæœ¬ï¼Œä¸€ä¸ªå•ç‹¬çš„workerçº¿ç¨‹ï¼Œæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ worker context.

![image-20190701103038844](./images/image-20190701103038844.png)

ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ç§ç½‘ç»œä»£ç†æœåŠ¡å™¨ï¼Œå¯ç¼–ç¨‹æ‹¦æˆªä»£ç†è¯·æ±‚å’Œè¿”å›ï¼Œç¼“å­˜æ–‡ä»¶ã€‚



![image-20190701103017367](./images/image-20190701103017367.png)



####  

å†å›æ¥çœ‹ä¸‹ï¼ŒPWAçš„ç¼“å­˜åŸç†

æ ¸å¿ƒå°±æ˜¯æµè§ˆå™¨çš„serviceWorkerå¦å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹è´Ÿè´£å»ç›‘å¬æ‰€æœ‰httpsè¯·æ±‚ï¼ˆæ³¨æ„æ˜¯httpsï¼‰,å½“å‘ç°æŸäº›èµ„æºæ˜¯éœ€è¦ç¼“å­˜ä¸‹æ¥çš„ä»–ä¼šæŠŠèµ„æºæ‹‰å–åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œè®¿é—®çš„æ—¶å€™æ‹¦æˆªè¯·æ±‚ï¼Œä¸èµ°ç½‘ç»œè¯·æ±‚ï¼Œç›´æ¥è¯»å–æœ¬åœ°èµ„æºã€‚è¿™æ ·èµ„æºç›¸å½“äºéƒ½æ˜¯ç”¨æˆ·æœ¬åœ°çš„èµ„æº,å“åº”é€Ÿåº¦è‚¯å®šé£å¿«ï¼Œè¿˜æœ‰å°±æ˜¯èµ„æºéƒ½åœ¨ç”¨æˆ·æµè§ˆå™¨é‡Œé¢ï¼Œå°±ç®—æ–­äº†ç½‘,èµ„æºä¹Ÿéƒ½æ˜¯èƒ½æ­£å¸¸è®¿é—®ã€‚



####ç‰¹æ€§

1 ä¸èƒ½**ç›´æ¥**æ“ä½œDOMï¼›

2 å¿…é¡»åœ¨httpsç¯å¢ƒä¸‹å·¥ä½œ(æœ¬åœ°ç¯å¢ƒé™¤å¤–)ï¼›

3 æ”¯æŒç¦»çº¿ä½“éªŒï¼Œå¼€å‘è€…èƒ½å¤Ÿå…¨é¢æ§åˆ¶ç¼“å­˜æ–‡ä»¶ä»¥åŠé¡µé¢æ‰€å‘é€ç½‘ç»œè¯·æ±‚çš„å¤„ç†æ–¹å¼ï¼›

**4 ä¸ç”¨æ—¶ä¼šè¢«ä¸­æ­¢ï¼Œå¹¶åœ¨ä¸‹æ¬¡æœ‰éœ€è¦æ—¶é‡å¯ï¼›**

5  å¹¿æ³›åœ°åˆ©ç”¨äº† promiseï¼›

6 æ‹¥æœ‰å›ºå®šçš„ç”Ÿå‘½å‘¨æœŸ(ä¸‹æ–‡è¯¦è¿°)ï¼›



#### ç”Ÿå‘½å‘¨æœŸ

Service Worker çš„ç”Ÿå‘½å‘¨æœŸ**å®Œå…¨ç‹¬ç«‹äºç½‘é¡µ**ã€‚

![image-20190702164753542](./images/image-20190702164753542.png)

#####é¦–æ¬¡æ³¨å†Œ

1 é¦–å…ˆåœ¨UIä¸»çº¿ç¨‹çš„javascriptä¸­æ³¨å†ŒserverWoker,serviceWorkerå°†ä¼šåœ¨æµè§ˆå™¨åå°å¼€å¯æœåŠ¡å·¥ä½œçº¿ç¨‹ï¼›

2 è‹¥è§£æserviceWorkerè„šæœ¬å‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿›å…¥å¤±è´¥`redundant`çŠ¶æ€ï¼›

3 è‹¥è§£ææ³¨å†Œé¡ºåˆ©å®Œæˆï¼Œè¿›å…¥` installing` çŠ¶æ€ï¼Œè¿™é‡Œå¸¸å¸¸ç”¨äºå¤„ç†ç¼“å­˜æŸäº›é™æ€æ–‡ä»¶ã€‚

4 è‹¥æ–‡ä»¶å‡å·²æˆåŠŸç¼“å­˜ï¼Œé‚£ä¹ˆ Service Worker  å°±å®‰è£…å®Œæ¯•,è¿›å…¥ ` installed`çŠ¶æ€;

5 è‹¥ç¼“å­˜è¿‡ç¨‹ä¸­ï¼Œä»»ä½•æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œé‚£ä¹ˆå®‰è£…è¿‡ç¨‹å°±ä¼šå¤±è´¥ï¼ŒService Worker å°±æ— æ³•æ¿€æ´»ï¼›(å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¸å¿…æ‹…å¿ƒï¼Œå®ƒä¸‹æ¬¡ä¼šå†è¯•ä¸€æ¬¡ï¼‰ã€‚

6 å®‰è£…æˆåŠŸåï¼Œè¿›å…¥ `activiting `çŠ¶æ€ï¼Œè¿™æ˜¯ç®¡ç†æ—§ç¼“å­˜çš„ç»ä½³æœºä¼šï¼›

Service Worker å°†ä¼š**å¯¹å…¶ä½œç”¨åŸŸå†…**çš„æ‰€æœ‰é¡µé¢å®æ–½æ§åˆ¶ï¼Œä¸è¿‡ï¼Œé¦–æ¬¡æ³¨å†Œè¯¥ Service Worker çš„é¡µé¢éœ€è¦**å†æ¬¡**åŠ è½½æ‰ä¼šå—å…¶æ§åˆ¶ã€‚ æœåŠ¡å·¥ä½œçº¿ç¨‹å®æ–½æ§åˆ¶åï¼Œå®ƒå°†å¤„äºä»¥ä¸‹ä¸¤ç§çŠ¶æ€ä¹‹ä¸€ï¼šæœåŠ¡å·¥ä½œçº¿ç¨‹ç»ˆæ­¢ä»¥èŠ‚çœå†…å­˜ï¼Œæˆ–å¤„ç†è·å–å’Œæ¶ˆæ¯äº‹ä»¶ï¼Œä»é¡µé¢å‘å‡ºç½‘ç»œè¯·æ±‚æˆ–æ¶ˆæ¯åå°†ä¼šå‡ºç°åä¸€ç§çŠ¶æ€ã€‚



##### æ›´æ–°

1 å½“ä¿®æ”¹serviceWorkeræ³¨å†Œçš„è„šæœ¬ï¼Œç”¨æˆ·é‡æ–°è¿›å…¥é¡µé¢ï¼Œæµè§ˆå™¨ä¼šå°è¯•åœ¨åå°é‡æ–°ä¸‹è½½å®šä¹‰ Service Worker çš„è„šæœ¬æ–‡ä»¶ã€‚ å¦‚æœ Service Worker æ–‡ä»¶ä¸å…¶å½“å‰**æ‰€ç”¨æ–‡ä»¶å­˜åœ¨å­—èŠ‚å·®å¼‚**ï¼Œåˆ™å°†å…¶è§†ä¸º*æ–° Service Worker*ã€‚

2 æ–° Service Worker å°†ä¼šå¯åŠ¨ï¼Œä¸”å°†ä¼šè§¦å‘ `install` äº‹ä»¶ï¼Œ æ­¤æ—¶ï¼Œæ—§ Service Worker ä»æ§åˆ¶ç€å½“å‰é¡µé¢ï¼Œå› æ­¤æ–° Service Worker å°†è¿›å…¥ `waiting` çŠ¶æ€ã€‚

3 å­˜åœ¨ä¸‹åˆ—å‡ ç§æƒ…å†µä¹‹ä¸€çš„æ—¶å€™ï¼Œæ—§ Service Worker å°†ä¼šè¢«ç»ˆæ­¢ï¼Œæ–° Service Worker å°†ä¼šå–å¾—æ§åˆ¶æƒ

- å½“å‰æ²¡æœ‰æ¿€æ´»çš„ worker
- å¦‚æœåœ¨ Service Worker çš„è„šæœ¬ä¸­ `self.skipWaiting()` è¢«è°ƒç”¨
- å¦‚æœç”¨æˆ·è®¿é—®å…¶ä»–é¡µé¢å¹¶é‡Šæ”¾äº†ä¹‹å‰æ¿€æ´»çš„ worker
- åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´(24å°æ—¶)è¿‡å»åï¼Œä¹‹å‰ä¸€ä¸ªæ¿€æ´»çš„ worker è¢«é‡Šæ”¾

4 æ–° Service Worker å–å¾—æ§åˆ¶æƒåï¼Œå°†ä¼šè§¦å‘å…¶ `activate` äº‹ä»¶ã€‚



 **å­˜åœ¨ä¸‹åˆ—å‡ ç§æƒ…å†µä¹‹ä¸€çš„æ—¶å€™,service Worker å°†è¿›å…¥ redundantçŠ¶æ€**

- **å¤„äº installing çŠ¶æ€æ—¶å®‰è£…å¤±è´¥**
- **å¤„äº activating çŠ¶æ€æ—¶æ¿€æ´»å¤±è´¥**
- **ä¸€ä¸ªæ–°çš„ Service Worker ä»£æ›¿äº†å®ƒç§°ä¸ºäº†æ¿€æ´»çš„ Service Worker**



#### æµè§ˆå™¨å…¼å®¹æ€§

![image-20190701115224824](./images/image-20190701115224824.png)

#### chromeè°ƒè¯•

å‚è€ƒæ–‡æ¡£ï¼š[å¦‚ä½•è¿›è¡Œ Service Worker è°ƒè¯•](https://lavas.baidu.com/pwa/offline-and-cache-loading/service-worker/service-worker-debug)

###### å¤‡æ³¨ï¼šç®€å•æ¼”ç¤ºä¸€ä¸‹ä¸‹~~~ 

###workbox

ä¸€ä¸ªä¸ºç½‘é¡µåº”ç”¨æ·»åŠ ç¦»çº¿æ”¯æŒçš„ JavaScript åº“ï¼Œ PWA ç›¸å…³çš„å·¥å…·é›†åˆã€‚

Google å®˜æ–¹çš„ PWA æ¡†æ¶ï¼Œå®ƒè§£å†³çš„å°±æ˜¯**ç”¨åº•å±‚ API å†™ PWA å¤ªè¿‡å¤æ‚çš„é—®é¢˜**ã€‚è¿™é‡Œè¯´çš„åº•å±‚ APIï¼ŒæŒ‡çš„å°±æ˜¯å»ç›‘å¬ SW çš„ installã€activeã€ fetch äº‹ä»¶åšç›¸åº”é€»è¾‘å¤„ç†ç­‰

######å¤‡æ³¨ï¼šåœ¨è¿™é‡Œ å¸¦é¢†å¤§å®¶ç®€å•çœ‹ä¸‹åº•å±‚APIè°ƒç”¨

####ç®€å•ä½¿ç”¨ï¼šæ— éœ€installå®‰è£… ç›´æ¥ä½¿ç”¨

çœ‹ä¸€ä¸‹ [å®˜ç½‘](https://developers.google.com/web/tools/workbox/)

Workbox ä½œä¸º SW æ¨¡å—ä½¿ç”¨ï¼Œæä¾›äº†ä¸¤ä¸ªæœ€ä¸»è¦çš„æ¥å£ï¼š

- `workbox.routing.registerRoute`ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° capture æ˜¯æ­£åˆ™è¡¨è¾¾å¼æˆ– Express é£æ ¼çš„è·¯ç”±å­—ç¬¦ä¸²ï¼Œå£°æ˜éœ€è¦åŒ¹é…é‚£äº›è¯·æ±‚ï¼Œç¬¬äºŒä¸ªå‚æ•°ç”¨äºå‘Šè¯‰ Workbox å¯¹å‰é¢æ‹¦æˆªåˆ°çš„è¯·æ±‚åšä½•å¤„ç†ã€‚

- `workbox.strategies.xxx`ï¼Œç”¨åœ¨ registerRoute çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¡¨æ˜ä½¿ç”¨ä½•ç§ç¼“å­˜ç­–ç•¥(å³å‰æ–‡æåˆ°çš„PWAçš„äº”ç§ç¼“å­˜ç­–ç•¥)ã€‚

  

#####è¿›å…¥æœ¬æ¬¡åˆ†äº«çš„é‡ç‚¹ï¼Œå¼€å§‹ç¼–ç¨‹

UI ä¸»çº¿ç¨‹ main.js

ç”¨äºæ³¨å†ŒSW

```
   //æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒserviceWorker
   if ('serviceWorker' in navigator) {
   		//åœ¨æ•´ä¸ªUIé¡µé¢åŠ è½½å®Œå…¨åï¼Œå¼€å§‹æ³¨å†ŒSW
                window.addEventListener('load', function() {
                //ä¸€ä¸ªå…¸å‹çš„PROMISEå‡ºç°
                // navigator.serviceWorker.register('/sw.js'ï¼Œ'/') ç¬¬äºŒä¸ªå‚æ•°å¯é€‰
                
                    navigator.serviceWorker.register('app/sw.js').then(function(registration) {
                        // Registration was successful
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function(err) {
                        // registration failed :(
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }

        }
```



SWçº¿ç¨‹ï¼š sw.js  

SWä¸»ä½“æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†å¯¹å„ç§ç±»å‹çš„ç½‘ç»œèµ„æºè¿›è¡Œç®¡æ§

```
importScripts('https://storage.googleapis.com/workbox-cdn/releases/4.3.1/workbox-sw.js');

if (workbox) {
    console.log(`Yay! Workbox is loaded ğŸ‰`);
    skipWaiting();
    // éœ€è¦è¢«ç¼“å­˜çš„æ–‡ä»¶çš„ URL åˆ—è¡¨
    /**
     * é æ‰‹åŠ¨ç»´æŠ¤ precache.precacheAndRoute API ä¸­çš„é¢„ç¼“å­˜å†…å®¹åˆ—è¡¨æ˜¯ä¸å¯èƒ½çš„ï¼Œrevision æˆ‘ä»¬æ— æ³•æ‰‹åŠ¨ç»´æŠ¤ï¼Œä¸€èˆ¬æ˜¯è¦å€ŸåŠ©ä¸€äº›å·¥å…·æ¥å¹²è¿™ä¸ªäº‹æƒ…
     * å¦‚ï¼šworkbox-webpack-pluginç­‰
     *  */
    workbox.precaching.precacheAndRoute([
        '/assets/02.png',
    ]);

    // JS è¯·æ±‚: ç½‘ç»œä¼˜å…ˆ
    workbox.routing.registerRoute(
        new RegExp('.*\.js'),
        workbox.strategies.networkFirst({
            cacheName: 'workbox:js',
        })
    );
    // CSS è¯·æ±‚: ç¼“å­˜ä¼˜å…ˆï¼ŒåŒæ—¶åå°æ›´æ–°åä¸‹æ¬¡æ‰“å¼€é¡µé¢æ‰ä¼šè¢«é¡µé¢ä½¿ç”¨
    workbox.routing.registerRoute(
        // Cache CSS files
        /.*\.css/,
        // Use cache but update in the background ASAP
        workbox.strategies.staleWhileRevalidate({
            // Use a custom cache name
            cacheName: 'workbox:css',
        })
    );

    // å›¾ç‰‡è¯·æ±‚: ç¼“å­˜ä¼˜å…ˆ
    workbox.routing.registerRoute(
        // Cache image files.
        /\.(?:png|jpg|jpeg|svg|gif)$/,
        // Use the cache if it's available.
        new workbox.strategies.CacheFirst({
            // Use a custom cache name.
            cacheName: 'workbox:image',
            plugins: [
                new workbox.expiration.Plugin({
                    // Cache only 20 images.
                    maxEntries: 20,
                    // Cache for a maximum of a week.
                    maxAgeSeconds: 7 * 24 * 60 * 60,
                })
            ],
        })
    );

} else {
    console.log(`Boo! Workbox didn't load ğŸ˜¬`);
}
```

é€šè¿‡chrome æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“è¡¨ç°

#####é¦–æ¬¡è¿è¡Œï¼š

1 console:æ‰“å°æ³¨å†ŒæˆåŠŸçš„ä¿¡æ¯

![image-20190701162107852](./images/image-20190701162107852.png) 

2 network:å’Œå¹³æ—¶è®¿é—®æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯åŠ è½½äº†ä¸€äº›workboxçš„ä¾èµ–

![image-20190701162057450](./images/image-20190701162057450.png)

3 appliaction:æ˜¾ç¤ºæ³¨å†Œçš„SWä¿¡æ¯

![image-20190701162549867](./images/image-20190701162549867.png)

##### å†æ¬¡åˆ·æ–°

1 console ï¼š

![image-20190701162427140](./images/image-20190701162427140.png)

2 networkï¼šå…¨éƒ¨çš„ cssã€pngã€js æ–‡ä»¶å‡è¢« ServiceWorker æ‹¦æˆªï¼ˆå›¾ä¸­ from ServiceWorker å¯ä»¥çœ‹å‡ºï¼‰

![image-20190701162156642](./images/image-20190701162156642.png)



####ä¿®æ”¹JSå’ŒCSSæ–‡ä»¶ååˆ·æ–°

1 console: 

![image-20190701163751535](./images/image-20190701163751535.png)

- ç”±äº png æ˜¯ Cache Firstï¼Œæ‰€ä»¥ç›´æ¥ä» ServiceWorker çš„ Cache è¿”å›ï¼Œæ²¡æœ‰çœŸæ­£çš„ç½‘ç»œè¯·æ±‚å‘å‡º
- ç”±äº js æ˜¯ Network Firstï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿ fetchï¼Œä¸”è¿è¡ŒæˆåŠŸï¼ˆåº•éƒ¨ Console æœ‰è¾“å‡ºå†…å®¹ï¼‰
- cssæ˜¯ StaleWhileRevalidateï¼Œè™½ç„¶åŒæ · fetch äº†æ–°çš„å†…å®¹ï¼Œä½†é¡µé¢å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œç”¨çš„è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„ Cacheï¼ˆä½†æ–°çš„æ–‡ä»¶å†…å®¹å·²ç»æ”¾åˆ° Cache Storage ä¸­ï¼‰

[è¿™é‡Œ](https://zhuanlan.zhihu.com/p/67931226)æœ‰ç›¸å…³è·¯ç”±è¯·æ±‚å’Œç¼“å­˜ç­–ç•¥è¯¦ç»†ä»‹ç»



é¡µé¢ç¼“å­˜ï¼š

åœ¨`sw.js`æ–‡ä»¶ä¸­æ–°å¢

```
 //ä¸»æ–‡æ¡£: ç½‘ç»œä¼˜å…ˆ
    workbox.routing.registerRoute(
        /.*\wb$/,
        new workbox.strategies.NetworkFirst({
            cacheName: 'workbox:njk',
        })
    );
```

chromeâ€”appliaction-å‹¾é€‰ offline

![image-20190704112539872](./images/image-20190704112539872.png)

åˆ·æ–°é¡µé¢

![image-20190704112655119](./images/image-20190704112655119.png)

é¡µé¢æ­£å¸¸è¿”å› å™¢è€¶ï¼ï¼ï¼

#####ä¸€èˆ¬æƒ¯ä¾‹

``HTML``é¡µé¢ ï¼šå¦‚æœå¸Œæœ›ç¦»çº¿ç¼“å­˜ï¼Œè¯·ä½¿ç”¨``NetworkFirst``,å¦‚æœä¸éœ€è¦ç¦»çº¿ç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨``NetworkOnly``æˆ–è€…ä¸è®¾ç½®ï¼›

``CSS``,``JS``,``image`` ï¼šè·¨åŸŸçš„ï¼ŒSW å¹¶æ²¡æœ‰åŠæ³•åˆ¤æ–­è¯·æ±‚ä¸‹æ¥çš„èµ„æºæ˜¯å¦æ­£ç¡®ï¼ˆHTTP 200ï¼‰ï¼Œå¦‚æœç¼“å­˜é”™è¯¯æ–‡ä»¶ï¼Œé—®é¢˜éå¸¸ä¸¥é‡ï¼›æ‰€ä»¥å»ºè®®ä½¿ç”¨``StaleWhileRevalidate``,æ—¢å¯ä»¥ä¿è¯é¡µé¢é€Ÿåº¦ï¼Œå³ä½¿å¤±è´¥ï¼Œç”¨æˆ·åˆ·æ–°å°±å¯ä»¥æ›´æ–°ï¼›éè·¨åŸŸçš„ï¼Œç›´æ¥ä½¿ç”¨CacheFirst,å¹¶è®¾ç½®ä¸€å®šçš„å¤±æ•ˆäº‹ä»¶ï¼Œè¯·æ±‚ä¸€æ¬¡å°±ä¸ä¼šå†å˜åŠ¨äº†ã€‚

 

#####å°çš„çŸ¥è¯†ç‚¹

1 åªé’ˆå¯¹è¿è¡Œæ—¶ç¼“å­˜

workboxåªå¯¹â€œæœ‰æ•ˆçš„â€å“åº”è¿›è¡Œç¼“å­˜ï¼Œé‚£åˆ¤æ–­å“åº”çš„æœ‰æ•ˆæ€§æ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨cacheableResponseæ¨¡å—è¿›è¡Œè‡ªå®šä¹‰â€œä»€ä¹ˆæ˜¯æœ‰æ•ˆçš„å“åº”â€ã€‚æ¯”å¦‚è¦æ±‚è¿”å›çŠ¶æ€ç ä¸º[0ï¼Œ200]æ‰æ˜¯æœ‰æ•ˆçš„

2

å¦‚æœå¸Œæœ›webåº”ç”¨ç¦»çº¿å·¥ä½œï¼Œæˆ–è€…æœ‰äº›èµ„äº§å¯ä»¥è¢«ç¼“å­˜å¾ˆé•¿æ—¶é—´ï¼Œé‚£ä¹ˆé¢„ç¼“å­˜æ˜¯æœ€å¥½çš„æ–¹æ³•ã€‚precacheå°†ç¡®ä¿åœ¨SWä¹‹å‰ä¸‹è½½å¹¶ç¼“å­˜æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€å¦‚æœå®‰è£…äº†SWï¼Œåˆ™ä¼šç¼“å­˜æ–‡ä»¶ã€‚

Workboxæä¾›äº†ä¸€ç§ç®€å•çš„é¢„ç¼“å­˜æ–‡ä»¶çš„æ–¹æ³•ï¼Œç¡®ä¿éšç€SWçš„æ›´æ”¹ï¼Œé¢„ç¼“å­˜æ–‡ä»¶å¾—åˆ°æœ‰æ•ˆçš„ç»´æŠ¤ï¼Œåªä¸‹è½½æ›´æ–°çš„æ–‡ä»¶ï¼Œå¹¶åœ¨SWè¢«å†—ä½™åè¿›è¡Œæ¸…ç†ã€‚

```javascript
workbox.precaching.precacheAndRoute([
    '/styles/index.0c9a31.css',
    '/scripts/main.0d5770.js',
    { url: '/index.html', revision: '383676' },
]); 
```

4 PC æµè§ˆå™¨ æ¯ä¸ªTABéƒ½æ˜¯ä¸€ä¸ªclient ï¼Œç»´æŠ¤ç‹¬è‡ªçš„ cache Storage

  ![image-20190703181337852](./images/image-20190703181337852.png)

5  ä¸é€æ˜å“åº”

è·¨æºè¯·æ±‚ï¼Œä½†æ˜¯å“åº”ä¸æ”¯æŒCORSã€‚åšå†³ä¸å¯ä»¥ç”¨ cacheOnly æˆ–è€… cacheFirstç­–ç•¥ç¼“å­˜ã€‚ä¸ºä»€ä¹ˆå•ç‹¬æåˆ°è¿™ä¸ªå‘¢ï¼Ÿ

`serviceworker`å¯ä»¥æ‹¦æˆªä½œç”¨åŸŸä¸‹å‘èµ·çš„æ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬ **è·¨è¶Šè¯·æ±‚** ã€‚é€šå¸¸åœ¨ç¼“å­˜é™æ€èµ„æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿èµ„æºæ˜¯æ­£ç¡®å“åº”çš„(æ¯”å¦‚è¿”å›httpçŠ¶æ€ç 200)ï¼Œå¦‚æœè¿”å›çš„æ˜¯ `404` æˆ–è€… `500` ä¹‹ç±»çš„ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥ç¼“å­˜è¯¥èµ„æºã€‚ä½†æ˜¯åœ¨ **è·¨åŸŸ** çš„è¯·æ±‚ä¸‹ï¼Œé»˜è®¤çš„ `Request.mode no-cors` æˆ‘ä»¬ **ä¸èƒ½** è¯»å–è¿”å›çš„çŠ¶æ€ç ï¼Œä¹Ÿå°±ä¸çŸ¥é“èµ„æºæ˜¯å¦OKï¼›å› æ­¤éœ€è¦è®¾ç½®è·¨åŸŸèµ„æºçš„ `cors` å±æ€§ï¼Œæ¯”å¦‚é¡µé¢é‡Œé™æ€èµ„æºï¼Œè®¾ç½® `crossorigin=anonymous` ï¼Œè¿™æ ·ä¼šè§¦å‘æµè§ˆå™¨å‘èµ· `CORS` è¯·æ±‚ï¼Œä¹Ÿå°±è¦æ±‚æˆ‘ä»¬çš„æœåŠ¡å™¨è¿”å›headerä¸­ï¼Œå¢åŠ  `Access-Control-Allow-Origin` æ¥å…è®¸æˆ‘ä»¬è·¨åŸŸè®¿é—®è¯¥èµ„æºã€‚å¦‚æœæœåŠ¡æ²¡æœ‰å¢åŠ  `Access-Control-Allow-Origin`ï¼Œåœ¨ç¼“å­˜ç­–ç•¥çš„é€‰å–ä¸Šå®˜æ–¹æ¨è`NetworkFirst`æˆ–è€…`StaleWhileRevalidate`

6  ä¸ä¸»çº¿ç¨‹é€šä¿¡

 é€šè¿‡ postMessageæ–¹æ³•

7 å®¹é‡

![image-20190704113330318](./images/image-20190704113330318.png)

### å…¶å®ƒ

æ¶ˆæ¯æ¨é€ä»¥åŠé€šçŸ¥  åç»­å†èŠ



å‚è€ƒæ–‡æ¡£ï¼š

[Workboxå®˜ç½‘](https://developers.google.com/web/tools/workbox/guides/precache-files/)

[ServiceWorkerå®˜ç½‘](https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle?hl=zh-cn)

[https://github.com/sophister/2bugua5/blob/master/category/pwa/pwa-speed-up/pwa-speed-up.md#%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82](https://github.com/sophister/2bugua5/blob/master/category/pwa/pwa-speed-up/pwa-speed-up.md#è·¨åŸŸè¯·æ±‚) by æ¯›æ‰¿æ° 

https://juejin.im/entry/57f89f938ac2470058ac32c4 by æ–‡è”º

https://juejin.im/post/595233e55188250d9208527c by UCå†…æ ¸å‘å¸ƒ

### 







